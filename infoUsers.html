<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Información de Usuarios</title>
  <link rel="stylesheet" href="./css/style-infoUsers.css">
</head>

<body>

  <div class="rectanguloInicio">
    <h1>Información de Usuarios</h1>
  </div>

  <h2 class="titulos contenedorUserAuthen">Usuario Autenticado</h2>
  <div id="userInfo" class="usuario-autenticado"></div>


  <div class="infoPagina">
    <div class="infoPaginaTitulo">
      <h1>Página Web</h1>
    </div>
    <h2 class="titulos">Usuarios registrados</h2>
    <div class="tabla">
      <div id="allUsersInfo"></div>
    </div>
    <div id="totalUsuariosRegistrados"></div>

    <div class="rectanguloTitulos">
      <h2 class="titulos">Usuarios que han realizado la evaluación previa</h2>
    </div>
    <div id="evaluacionPreviaInfo"></div>

    <div class="rectanguloTitulos">
      <h2 class="titulos">Puntuaciones y respuestas de las evaluaciones previas</h2>
    </div>
    <div class="cuestionarios"></div>
    <div id="puntuacionesEvaluacionPrevia" class="usuarios-evaluacion-previa"></div>


  </div>

  <div class="infoAplicacion">
    <div class="infoPaginaTitulo">
      <h1>Aplicación Móvil</h1>
    </div>
  </div>

  <button id="exportCSVButton">Exportar como CSV</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnSAUDBaTQQJdcgtu9MFZ2Xpr3oOKNdqw",
      authDomain: "prueba2-31849.firebaseapp.com",
      databaseURL: "https://prueba2-31849-default-rtdb.firebaseio.com",
      projectId: "prueba2-31849",
      storageBucket: "prueba2-31849.appspot.com",
      messagingSenderId: "593735540788",
      appId: "1:593735540788:web:4fa918ce020f5050c66a61"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function obtenerUsuariosInfo() {
      onAuthStateChanged(auth, async (user) => {
        const userInfoElement = document.getElementById('userInfo');
        const allUsersInfoElement = document.getElementById('allUsersInfo');
        const evaluacionPreviaInfoElement = document.getElementById('evaluacionPreviaInfo');
        const puntuacionesEvaluacionPreviaElement = document.getElementById('puntuacionesEvaluacionPrevia');
        userInfoElement.innerHTML = "";
        allUsersInfoElement.innerHTML = "";
        evaluacionPreviaInfoElement.innerHTML = "";
        puntuacionesEvaluacionPreviaElement.innerHTML = "";

        if (user) {
          const userId = user.uid;
          const userDocRef = doc(db, 'users', userId);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists) {
            const userData = userDoc.data();

            const userInfoDiv = document.createElement('div');
            userInfoDiv.classList.add('usuario-info');
            userInfoDiv.classList.add('usuario-autenticado');

            const fields = [
              { label: 'ID del usuario', value: userId },
              { label: 'Nombre', value: userData.nombre },
              { label: 'Apellidos', value: userData.apellido },
              { label: 'Correo electrónico', value: userData.email },
            ];

            fields.forEach(field => {
              const rowDiv = document.createElement('div');
              rowDiv.classList.add('usuario-row');
              rowDiv.innerHTML = `
                <div class="campo">${field.label}:</div>
                <div class="valor">${field.value}</div>
            `;
              userInfoDiv.appendChild(rowDiv);
            });

            userInfoElement.appendChild(userInfoDiv);

            const hrElement = document.createElement('hr');
            hrElement.classList.add('usuario-separator');
            userInfoElement.appendChild(hrElement);
          } else {
            userInfoElement.appendChild(createParagraph("El documento del usuario autenticado no existe"));
          }
        } else {
          userInfoElement.appendChild(createParagraph("No hay usuario autenticado"));
        }

        const usersCollectionRef = collection(db, 'users');
        const usersSnapshot = await getDocs(usersCollectionRef);
        const totalUsuariosRegistrados = usersSnapshot.size;
        const totalUsuariosRegistradosElement = document.getElementById('totalUsuariosRegistrados');
        totalUsuariosRegistradosElement.innerHTML = `<strong style="color: #2DAAA7; font-size: 18px;">Total de registrados: </strong>${totalUsuariosRegistrados}`;
        totalUsuariosRegistradosElement.insertAdjacentHTML('afterend', '<hr>');

        for (const doc of usersSnapshot.docs) {
          const userData = doc.data();
          const userId = doc.id;

          const userDiv = document.createElement('div');
          userDiv.classList.add('usuario-info');

          const fields = [
            { label: 'ID del usuario', value: userId },
            { label: 'Nombre', value: userData.nombre },
            { label: 'Apellidos', value: userData.apellido },
            { label: 'Correo electrónico', value: userData.email },
            { label: 'Número Telefónico', value: userData.numeroTelefonico },
            { label: 'Edad', value: userData.edad },
            { label: 'Estado civil', value: userData.estadoCivil },
            { label: 'Género', value: userData.genero },
            { label: 'Ocupación', value: userData.ocupacion },
            { label: 'Nivel de estudios', value: userData.nivelEstudios }
          ];

          fields.forEach(field => {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('usuario-row');
            rowDiv.innerHTML = `
            <div class="campo">${field.label}:</div>
            <div class="valor">${field.value}</div>
        `;
            userDiv.appendChild(rowDiv);
          });

          allUsersInfoElement.appendChild(userDiv);

          const hrElement = document.createElement('hr');
          hrElement.classList.add('usuario-separator');
          allUsersInfoElement.appendChild(hrElement);
        }

        const evaluacionRealizadaCollectionRef = collection(db, 'evaluacionRealizada');
        const evaluacionRealizadaSnapshot = await getDocs(evaluacionRealizadaCollectionRef);

        evaluacionPreviaInfoElement.appendChild(document.createElement('br'));
        let totalRealizada = 0;
        let totalNoRealizada = 0;
        for (const doc of evaluacionRealizadaSnapshot.docs) {
          const userId = doc.id;
          const evaluacionRealizadaData = doc.data();
          const evaluacionPreviaRealizada = evaluacionRealizadaData.evaluacionPreviaRealizada ? "Realizada" : "No realizada";

          const evaluacionPreviaRowDiv = document.createElement('div');
          evaluacionPreviaRowDiv.classList.add('usuario-row');

          const idUsuarioDiv = document.createElement('div');
          idUsuarioDiv.classList.add('campo');
          idUsuarioDiv.textContent = 'ID del usuario:';
          evaluacionPreviaRowDiv.appendChild(idUsuarioDiv);

          const valorIdUsuarioDiv = document.createElement('div');
          valorIdUsuarioDiv.classList.add('valor');
          valorIdUsuarioDiv.textContent = userId;
          evaluacionPreviaRowDiv.appendChild(valorIdUsuarioDiv);

          const evaluacionPreviaDiv = document.createElement('div');
          evaluacionPreviaDiv.classList.add('campo');
          evaluacionPreviaDiv.textContent = 'Evaluación Previa:';
          evaluacionPreviaRowDiv.appendChild(evaluacionPreviaDiv);

          const valorEvaluacionPreviaDiv = document.createElement('div');
          valorEvaluacionPreviaDiv.classList.add('valor');
          valorEvaluacionPreviaDiv.textContent = evaluacionPreviaRealizada;
          evaluacionPreviaRowDiv.appendChild(valorEvaluacionPreviaDiv);

          evaluacionPreviaInfoElement.appendChild(evaluacionPreviaRowDiv);

          // Incrementar el contador según si la evaluación previa está realizada o no
          if (evaluacionPreviaRealizada === "Realizada") {
            totalRealizada++;
          } else {
            totalNoRealizada++;
          }
        }

        // Mostrar el total de usuarios que han realizado y no han realizado la evaluación previa
        evaluacionPreviaInfoElement.insertAdjacentHTML('beforeend', `<hr class="usuario-separator"><strong style="color: #2DAAA7; font-size: 16px;">Total Realizadas: </strong>${totalRealizada}`);
        evaluacionPreviaInfoElement.insertAdjacentHTML('beforeend', `<hr class="usuario-separator"><strong style="color: #2DAAA7; font-size: 16px;">Total No Realizadas: </strong>${totalNoRealizada}`);
        evaluacionPreviaInfoElement.insertAdjacentHTML('beforeend', '<hr>');

        const evaluacionPreviaCollectionRef = collection(db, 'resultadosEvaluacionPrevia');
        const evaluacionPreviaSnapshot = await getDocs(evaluacionPreviaCollectionRef);
        puntuacionesEvaluacionPreviaElement.appendChild(document.createElement('br'));
        for (const doc of evaluacionPreviaSnapshot.docs) {
          const userId = doc.id;
          const evaluacionPreviaData = doc.data();

          const userDiv = document.createElement('div');
          userDiv.classList.add('usuario-info', 'usuario-evaluacion-previa');

          const fields = [
            { label: 'ID del usuario', value: userId },
            { label: 'Puntuación Total BAI', value: evaluacionPreviaData.puntuacionTotalBAI },
            { label: 'Puntuación Total BDI', value: evaluacionPreviaData.puntuacionTotalBDI },
            { label: 'Puntuación Total PSS', value: evaluacionPreviaData.puntuacionTotalPSS },
            { label: 'Puntuación Total MINI', value: `${evaluacionPreviaData.puntuacionTotalMINI.count} - ${evaluacionPreviaData.puntuacionTotalMINI.nivel}` },
            { label: 'Puntuación Total WBI', value: evaluacionPreviaData.puntuacionTotalWBI },
            { label: 'Puntuación Total ICSP', value: evaluacionPreviaData.puntuacionTotalICSP }
          ];

          fields.forEach(field => {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('usuario-row');
            rowDiv.innerHTML = `
              <div class="campo">${field.label}:</div>
              <div class="valor">${field.value}</div>
            `;
            userDiv.appendChild(rowDiv);
          });

          puntuacionesEvaluacionPreviaElement.appendChild(userDiv);

          const hrElement = document.createElement('hr');
          hrElement.classList.add('usuario-separator');
          puntuacionesEvaluacionPreviaElement.appendChild(hrElement);


          const cuestionariosRef = collection(doc.ref, 'cuestionarios');
          const cuestionariosSnapshot = await getDocs(cuestionariosRef);
          puntuacionesEvaluacionPreviaElement.appendChild(createParagraph(`<span class="campo palabraCuestionarios">Respuestas de cada cuestionario</span>`));
          let cuestionariosList = document.createElement('ul');

          const completarConCeros = (numero, longitud) => {
            return String(numero).padStart(longitud, '0');
          };

          // Después de imprimir "Cuestionarios:"
          puntuacionesEvaluacionPreviaElement.appendChild(document.createElement('br'));
          // Crear un div para contener todos los cuestionarios
          const cuestionariosContainer = document.createElement('div');
          cuestionariosContainer.classList.add('cuestionarios-container');
          puntuacionesEvaluacionPreviaElement.appendChild(cuestionariosContainer);

          cuestionariosSnapshot.docs.forEach((cuestionarioDoc) => {
            const cuestionarioData = cuestionarioDoc.data();
            const cuestionarioNombre = cuestionarioDoc.id;

            let cuestionarioWrapper = document.createElement('div');
            cuestionarioWrapper.classList.add('campo');
            cuestionarioWrapper.classList.add('cuestionarioItem');

            // Crear un título para cada cuestionario
            let cuestionarioTitle = document.createElement('h3');
            cuestionarioTitle.classList.add('campo');
            cuestionarioTitle.textContent = cuestionarioNombre;

            let cuestionarioContent = document.createElement('div');
            cuestionarioContent.classList.add('contenidoCuestionario');

            const clavesOrdenadas = Object.keys(cuestionarioData)
              .sort((a, b) => a.localeCompare(b, 'es', { numeric: true }))
              .map((clave) => completarConCeros(clave, 2));

            clavesOrdenadas.forEach((key) => {
              const value = cuestionarioData[key];
              let item = document.createElement('div');
              item.classList.add('campoResultados');

              let label = document.createElement('span');
              label.classList.add('campoResultadosCampo');
              label.textContent = key + ":";

              let valor = document.createElement('span');
              valor.classList.add('campoResultadosValor');

              if (key.startsWith('Puntuación')) {
                valor.classList.add('contenidoCuestionario');
                
              }

              if (typeof value === 'object' && value !== null) {
                let objectString = '';
                for (const [subKey, subValue] of Object.entries(value)) {
                  objectString += `${subKey}: ${subValue}, `;
                }
                valor.textContent = objectString.slice(0, -2);
              } else {
                valor.textContent = value;
              }

              item.appendChild(label);
              item.appendChild(valor);
              cuestionarioContent.appendChild(item);


            });

            cuestionarioWrapper.appendChild(cuestionarioTitle);
            cuestionarioWrapper.appendChild(cuestionarioContent);
            // Agregar el cuestionario al contenedor de cuestionarios
            cuestionariosContainer.appendChild(cuestionarioWrapper);
          });


          puntuacionesEvaluacionPreviaElement.appendChild(cuestionariosList);
          puntuacionesEvaluacionPreviaElement.appendChild(document.createElement('hr'));

        }
      });
    }

    // Función para crear un elemento <p> con el contenido HTML especificado
    function createParagraph(html) {
      const p = document.createElement('p');
      p.innerHTML = html;
      return p;
    }

    document.addEventListener('DOMContentLoaded', obtenerUsuariosInfo);
  </script>
</body>

</html>

<!--AQUI MUESTRA PUNTUACIONES Y RESPUESTAS DE LA EVPREV  ORDENA BIEN EL ICSP exporta-->